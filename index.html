<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#102216">
    <title>Echo Memos PWA</title>
    
    <link rel="manifest" href='data:application/json,{"name":"Echo Memos","short_name":"Echo","start_url":".","display":"standalone","background_color":"#102216","theme_color":"#102216","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/5968/5968292.png","sizes":"512x512","type":"image/png"}]}'>

    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "media",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0df259",
                        "background-light": "#f5f8f6",
                        "background-dark": "#102216",
                        "surface-dark": "#1A2E22", 
                        "surface-darker": "#15261d"
                    }
                }
            }
        }
    </script>
    <style>
        :root { color-scheme: light dark; }
        .ProseMirror { outline: none !important; min-height: 24px; max-height: 200px; overflow-y: auto; }
        .ProseMirror p.is-editor-empty:first-child::before { content: "记录灵感..."; color: #666; pointer-events: none; height: 0; float: left; }
        
        /* 调试控制台样式 */
        #mobile-debug-console {
            display: none;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 10px;
            background: rgba(0,0,0,0.8);
            color: #0df259;
            padding: 8px;
            margin: 0 16px 12px;
            border-radius: 8px;
            border: 1px solid rgba(13, 242, 89, 0.3);
            white-space: pre-wrap;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display antialiased pb-48 transition-colors">

<header class="fixed top-0 left-0 w-full z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-black/5 dark:border-white/5">
    <div class="px-5 pt-12 pb-4 flex items-center justify-between">
        <h1 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
            <span class="text-primary material-symbols-outlined">graphic_eq</span> echo
        </h1>
        <span id="pwa-status" class="text-[10px] text-primary opacity-50">Local Mode</span>
        <button class="text-gray-900 dark:text-white p-2"><span class="material-symbols-outlined">search</span></button>
    </div>
</header>

<main id="memo-list" class="flex-1 w-full max-w-md mx-auto px-4 pt-32 pb-8 flex flex-col gap-5"></main>

<div class="fixed bottom-0 left-0 w-full z-50 bg-white/95 dark:bg-surface-dark/95 backdrop-blur-xl border-t border-white/5 pt-4 pb-8 shadow-2xl">
    <div id="mobile-debug-console"></div>
    
    <div class="max-w-md mx-auto flex items-end gap-3 px-4">
        <div class="flex-1 bg-gray-50 dark:bg-surface-darker rounded-[1.5rem] py-3 px-5 border border-transparent focus-within:border-primary/30 transition-all">
            <div id="editor"></div>
        </div>
        <button id="send-btn" class="flex-shrink-0 h-[3.4rem] w-[3.4rem] flex items-center justify-center rounded-full bg-primary text-background-dark active:scale-90 transition-all">
            <span class="material-symbols-outlined font-bold">arrow_upward</span>
        </button>
    </div>
</div>

<script type="module">
    import { Editor } from 'https://esm.sh/@tiptap/core'
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit'
    import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder'

    // --- 1. 移动端控制台实现 ---
    const debugEl = document.getElementById('mobile-debug-console');
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth < 768;

    if (isMobile) {
        debugEl.style.display = 'block';
        const originalLog = console.log;
        console.log = function(...args) {
            const time = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');
            
            const line = document.createElement('div');
            line.className = "mb-1 border-b border-white/5 pb-1";
            line.innerHTML = `<span class="opacity-50">[${time}]</span> ${message}`;
            debugEl.prepend(line); // 新消息在最前
            originalLog.apply(console, args);
        };
    }

    console.log("System Initialized. Mobile Detected:", isMobile);

    // --- 2. PWA Service Worker 注册 (调试模式) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const swCode = `
                self.addEventListener('install', () => self.skipWaiting());
                self.addEventListener('activate', (event) => {
                    event.waitUntil(clients.claim());
                    console.log('SW Activated - No Caching Mode');
                });
                self.addEventListener('fetch', (event) => {
                    // 调试模式：直接透传，不进行缓存
                    event.respondWith(fetch(event.request));
                });
            `;
            const blob = new Blob([swCode], { type: 'text/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(reg => {
                console.log("PWA SW Registered successfully");
                document.getElementById('pwa-status').innerText = 'PWA READY';
            }).catch(err => console.log("SW Register Error:", err));
        });
    }

    // --- 3. 数据库与编辑器逻辑 ---
    let db;
    const request = indexedDB.open('EchoPWA_DB', 2);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains('memos')) {
            db.createObjectStore('memos', { keyPath: 'id', autoIncrement: true });
        }
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        renderMemos();
    };

    const editor = new Editor({
        element: document.querySelector('#editor'),
        extensions: [
            StarterKit,
            Placeholder.configure({ placeholder: '在此输入内容...' })
        ],
        content: '',
        onUpdate: () => window.scrollTo(0, document.body.scrollHeight)
    });

    async function saveMemo() {
        const html = editor.getHTML();
        const text = editor.getText().trim();
        if (!text) return;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const h1 = tempDiv.querySelector('h1');
        const title = h1 ? h1.innerText : "";
        if (h1) h1.remove();

        const memo = {
            title,
            content: tempDiv.innerHTML,
            tags: text.match(/#[\w\u4e00-\u9fa5]+/g)?.map(t => t.replace('#', '')) || [],
            timestamp: Date.now()
        };

        const tx = db.transaction('memos', 'readwrite');
        tx.objectStore('memos').add(memo);
        tx.oncomplete = () => {
            console.log("Memo Saved:", { title: memo.title, tagCount: memo.tags.length });
            editor.commands.clearContent();
            renderMemos();
        };
    }

    window.deleteMemo = (id) => {
        const tx = db.transaction('memos', 'readwrite');
        tx.objectStore('memos').delete(id);
        tx.oncomplete = () => {
            console.log("Deleted Memo ID:", id);
            renderMemos();
        };
    };

    function renderMemos() {
        const container = document.getElementById('memo-list');
        const tx = db.transaction('memos', 'readonly');
        tx.objectStore('memos').getAll().onsuccess = (e) => {
            const memos = e.target.result.sort((a, b) => b.timestamp - a.timestamp);
            container.innerHTML = memos.map(memo => `
                <article class="bg-white dark:bg-surface-dark rounded-[2rem] p-6 shadow-sm border border-gray-100 dark:border-white/5">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-primary">${memo.title || 'Untitled'}</h3>
                        <button onclick="deleteMemo(${memo.id})" class="text-gray-300 hover:text-red-400 p-1">
                            <span class="material-symbols-outlined !text-[18px]">close</span>
                        </button>
                    </div>
                    <div class="prose prose-sm dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 mb-4">${memo.content}</div>
                    <div class="flex items-center justify-between">
                        <div class="flex gap-2">${memo.tags.map(tag => `<span class="text-primary text-[10px] font-bold bg-primary/10 px-2 py-1 rounded-full">#${tag}</span>`).join('')}</div>
                        <span class="text-[10px] text-gray-400 opacity-50 uppercase">${new Date(memo.timestamp).toLocaleTimeString()}</span>
                    </div>
                </article>
            `).join('');
        };
    }

    document.getElementById('send-btn').addEventListener('click', saveMemo);
</script>
</body>
</html>